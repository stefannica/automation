#
# (c) Copyright 2018 SUSE LLC
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.
#
---
{% set ns = namespace(clm_net_id=100, server_idx=0) %}
{% for network_group in scenario['network-groups'] if 'CLM' in network_group['component-endpoints'] %}
{%   set ns.clm_net_id = ns.clm_net_id+loop.index0 %}
{% endfor  %}
  product:
    version: 2

  baremetal:
    netmask: 255.255.255.0
    subnet: 192.168.{{ baremetal.subnet if baremetal is defined else ns.clm_net_id }}.0
    #server-interface: eth2

  servers:
{% for service_group in scenario['service-groups'] if service_group['member-count']|int %}
{%   for idx in range(service_group['member-count']|int) %}
{%     set server_id = "%s-%04d"|format(service_group.name, idx+1) %}
    - id: {{ baremetal.servers[ns.server_idx].id if baremetal is defined else server_id }}
      hostname: {{ scenario['cloud-name'] }}-{{ baremetal.servers[ns.server_idx].id if baremetal is defined else server_id }}
      ip-addr: 192.168.{{ baremetal.subnet if baremetal is defined else ns.clm_net_id }}.{{ baremetal.subnet_start + ns.server_idx if baremetal is defined else ns.server_idx + 1 }}
      role: {{ service_group.name|upper }}-ROLE
      server-group: RACK{{ (idx%3)+1 }}
      nic-mapping: {{ baremetal.servers[ns.server_idx].nic_mapping if baremetal is defined else 'HEAT' }}
{% if baremetal is defined and 'ilo_user' in baremetal.servers[ns.server_idx] %}
      ilo-user: {{ baremetal.servers[ns.server_idx].ilo_user }}
      ilo-password: {{ baremetal.servers[ns.server_idx].ilo_password }}
      ilo-ip: {{ baremetal.servers[ns.server_idx].ilo_ip }}
      mac-addr: {{ baremetal.servers[ns.server_idx].mac_addr }}
{% endif %}
{%     set ns.server_idx = ns.server_idx+1 %}


{%   endfor %}
{% endfor %}
