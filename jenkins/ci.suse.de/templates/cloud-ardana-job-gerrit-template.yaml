- job-template:
    name: '{ardana_gerrit_job}'
    project-type: pipeline
    concurrent: true
    node: cloud-trigger
    disabled: '{obj:disabled|False}'

    logrotate:
      numToKeep: -1
      daysToKeep: 14

    triggers:
      - gerrit:
          server-name: 'gerrit.suse.provo.cloud'
          trigger-on:
            - patchset-created-event:
                exclude-drafts: true
                exclude-no-code-change: false
            - draft-published-event
            - comment-added-contains-event:
                comment-contains-value: '^suse_recheck$'
            - comment-added-contains-event:
                comment-contains-value: '^recheck$'
          silent: true
          projects:
            - project-compare-type: 'REG_EXP'
              project-pattern: !include-raw: ../gerrit-project-regexp.txt
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: '{branch}'

    parameters:

      - validating-string:
          name: ardana_env
          default: '{ardana_env|}'
          regex: '[A-Za-z0-9-_]+'
          msg: >-
            Empty or malformed value (only alphanumeric, '-' and '_' characters are allowed).
          description: >-
            The virtual or hardware environment identifier. This field should either
            be set to one of the values associated with the known hardware environments
            (e.g. qe101), or to a value that will identify the created virtual environment.

            WARNING: if a virtual environment associated with the supplied ardana_env already
            exists, it will be replaced.

      - bool:
          name: reserve_env
          default: '{reserve_env|false}'
          description: >-
            Reserve the 'ardana_env' lockable resource throughout the execution of this job

      - validating-string:
          name: gerrit_patchset
          default: ''
          regex: '([0-9]+/[0-9]+)?'
          msg: The entered value failed validation
          description: >-
            A gerrit.suse.provo.cloud Gerrit change patchset to test.
            Both a Gerrit change number and a patchset number must be supplied, in the following form:

               <change_number>/<patchset_number>

            For jobs triggered by Gerrit, the Gerrit change ID and patch number are
            extracted from the GERRIT_CHANGE_NUMBER and GERRIT_PATCHSET_NUMBER environment
            variables.

      - bool:
          name: voting
          default: '{voting|false}'
          description: >-
            Determines if this job posts Verified labels on target Gerrit changes.

      - string:
          name: integration_test_job
          default: '{integration_test_job|openstack-ardana}'
          description: >-
            The downstream Ardana Jenkins integration job triggered by this job

      - bool:
          name: ses_enabled
          default: '{ses_enabled|false}'
          description: Configure SES backend for glance, cinder, cinder-backup and nova

      - bool:
          name: ses_rgw_enabled
          default: '{ses_rgw_enabled|false}'
          description: |
            Configure object-store service with RADOS Gateway. This only takes effect
            if ses_enabled is set to true.

      - string:
          name: git_automation_repo
          default: '{git_automation_repo|https://github.com/SUSE-Cloud/automation.git}'
          description: >-
            The git automation repository to use

      - string:
          name: git_automation_branch
          default: '{git_automation_branch|master}'
          description: >-
            The git automation branch

      - text:
          name: extra_params
          default:
          description: >-
            This field may be used to define additional parameters, one per line, in the form:

              <parameter_name>=<parameter-value>

            These parameters will be injected into the Jenkins job as environment variables that supplement
            or override the other parameters configured for the Jenkins job.
            This should not be used by default or regularly. It is meant to run job build customized in ways
            not already supported by the job's parameters, such as testing automation git pull requests
            with special configurations.

    pipeline-scm:
      scm:
        - git:
            url: ${{git_automation_repo}}
            branches:
              - ${{git_automation_branch}}
            browser: auto
            wipe-workspace: false
      script-path: jenkins/ci.suse.de/pipelines/openstack-ardana-gerrit.Jenkinsfile
      lightweight-checkout: false
